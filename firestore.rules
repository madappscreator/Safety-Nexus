rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuth() {
      return request.auth != null;
    }
    
    // Get user data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check if user belongs to a company
    function belongsToCompany(companyId) {
      return isAuth() && getUserData().companyId == companyId;
    }
    
    // Check user role
    function hasRole(role) {
      return isAuth() && getUserData().role == role;
    }
    
    // Check if user has any of the specified roles
    function hasAnyRole(roles) {
      return isAuth() && getUserData().role in roles;
    }
    
    // Platform admin check
    function isPlatformAdmin() {
      return hasRole('platform_admin');
    }
    
    // Company admin check
    function isCompanyAdmin() {
      return hasAnyRole(['company_admin', 'platform_admin']);
    }
    
    // HSE team check
    function isHSETeam() {
      return hasAnyRole(['hse_manager', 'hse_supervisor', 'safety_officer', 'platform_admin']);
    }

    // ============ COMPANIES ============
    match /companies/{companyId} {
      // Platform admins can read/write all companies
      // Company members can read their own company
      allow read: if isPlatformAdmin() || belongsToCompany(companyId);
      allow create: if isPlatformAdmin();
      allow update: if isPlatformAdmin() || (isCompanyAdmin() && belongsToCompany(companyId));
      allow delete: if isPlatformAdmin();
    }

    // ============ USERS ============
    match /users/{userId} {
      // Users can read their own profile
      // Admins can read/write users in their company
      allow read: if isAuth() && (
        request.auth.uid == userId ||
        isPlatformAdmin() ||
        (isCompanyAdmin() && belongsToCompany(resource.data.companyId))
      );
      allow create: if isPlatformAdmin() || isCompanyAdmin();
      allow update: if isAuth() && (
        request.auth.uid == userId ||
        isPlatformAdmin() ||
        (isCompanyAdmin() && belongsToCompany(resource.data.companyId))
      );
      allow delete: if isPlatformAdmin() || (isCompanyAdmin() && belongsToCompany(resource.data.companyId));
    }

    // ============ PERMITS ============
    match /permits/{permitId} {
      // Company members can read permits in their company
      allow read: if isAuth() && belongsToCompany(resource.data.companyId);
      // Any authenticated user can create a permit
      allow create: if isAuth() && belongsToCompany(request.resource.data.companyId);
      // Approvers and creators can update
      allow update: if isAuth() && belongsToCompany(resource.data.companyId);
      // Only admins can delete
      allow delete: if isCompanyAdmin() && belongsToCompany(resource.data.companyId);
    }

    // ============ INCIDENTS ============
    match /incidents/{incidentId} {
      allow read: if isAuth() && belongsToCompany(resource.data.companyId);
      allow create: if isAuth() && belongsToCompany(request.resource.data.companyId);
      allow update: if isAuth() && belongsToCompany(resource.data.companyId);
      allow delete: if isHSETeam() && belongsToCompany(resource.data.companyId);
    }

    // ============ INSPECTIONS ============
    match /inspections/{inspectionId} {
      allow read: if isAuth() && belongsToCompany(resource.data.companyId);
      allow create: if isAuth() && belongsToCompany(request.resource.data.companyId);
      allow update: if isAuth() && belongsToCompany(resource.data.companyId);
      allow delete: if isHSETeam() && belongsToCompany(resource.data.companyId);
    }

    // ============ TRAINING ============
    match /training/{trainingId} {
      allow read: if isAuth() && belongsToCompany(resource.data.companyId);
      allow write: if isAuth() && belongsToCompany(resource.data.companyId) && hasAnyRole(['company_admin', 'hse_manager', 'platform_admin']);
    }

    // ============ ASSETS ============
    match /assets/{assetId} {
      allow read: if isAuth() && belongsToCompany(resource.data.companyId);
      allow write: if isAuth() && belongsToCompany(resource.data.companyId) && hasAnyRole(['company_admin', 'hse_manager', 'platform_admin']);
    }

    // ============ CONTRACTORS ============
    match /contractors/{contractorId} {
      allow read: if isAuth() && belongsToCompany(resource.data.companyId);
      allow write: if isAuth() && belongsToCompany(resource.data.companyId) && isCompanyAdmin();
    }
  }
}

